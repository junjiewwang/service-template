# Auto-generated docker-compose.yaml
# Generated at: {{ .GENERATED_AT }}

services:
  {{ .SERVICE_NAME }}:
    build:
      context: .
      dockerfile: .tad/build/{{ .SERVICE_NAME }}/${DOCKERFILE}
      args:
        # ARM64 args
        - TLINUX_BASE_IMAGE_ARM=${TLINUX_BASE_IMAGE_ARM}
        - TLINUX_TAG_ARM=${TLINUX_TAG_ARM}
        - BUILDER_IMAGE_ARM=${BUILDER_IMAGE_ARM}
        # AMD64 args
        - TLINUX_BASE_IMAGE_X86=${TLINUX_BASE_IMAGE_X86}
        - TLINUX_TAG_X86=${TLINUX_TAG_X86}
        - BUILDER_IMAGE_X86=${BUILDER_IMAGE_X86}
        # Common args
        - DEPLOY_DIR=${DEPLOY_DIR}
    image: {{ .SERVICE_NAME }}:latest-${DOCKER_ARCH}
    container_name: {{ .SERVICE_NAME }}
{{- if .PORTS }}
    ports:
{{- range .PORTS }}
{{- if eq .Port .TargetPort }}
      - "{{ .Port }}"
{{- else }}
      - "{{ .Port }}:{{ .TargetPort }}"
{{- end }}
{{- end }}
{{- end }}
{{- if .ENV_VARS }}
    environment:
{{- range .ENV_VARS }}
      - {{ .Name }}={{ .Value }}
{{- end }}
{{- end }}
{{- if .VOLUMES }}
    volumes:
{{- range .VOLUMES }}
      - {{ .Source }}:{{ .Target }}
{{- end }}
{{- end }}
{{- if or .LIMITS_CPUS .LIMITS_MEMORY .RESERVATIONS_CPUS .RESERVATIONS_MEMORY }}
    deploy:
      resources:
{{- if or .LIMITS_CPUS .LIMITS_MEMORY }}
        limits:
{{- if .LIMITS_CPUS }}
          cpus: '{{ .LIMITS_CPUS }}'
{{- end }}
{{- if .LIMITS_MEMORY }}
          memory: {{ .LIMITS_MEMORY }}
{{- end }}
{{- end }}
{{- if or .RESERVATIONS_CPUS .RESERVATIONS_MEMORY }}
        reservations:
{{- if .RESERVATIONS_CPUS }}
          cpus: '{{ .RESERVATIONS_CPUS }}'
{{- end }}
{{- if .RESERVATIONS_MEMORY }}
          memory: {{ .RESERVATIONS_MEMORY }}
{{- end }}
{{- end }}
{{- end }}
{{- if .HEALTHCHECK_ENABLED }}
    healthcheck:
{{- if eq .HEALTHCHECK_TYPE "http" }}
      test: ["CMD", "curl", "-f", "http://localhost:{{ .HEALTHCHECK_HTTP_PORT }}{{ .HEALTHCHECK_HTTP_PATH }}"]
{{- else }}
      test: ["CMD", "/bin/sh", "/usr/local/services/${SERVICE_NAME}/hooks/healthchk.sh"]
{{- end }}
{{- if .HEALTHCHECK_INTERVAL }}
      interval: {{ .HEALTHCHECK_INTERVAL }}
{{- end }}
{{- if .HEALTHCHECK_TIMEOUT }}
      timeout: {{ .HEALTHCHECK_TIMEOUT }}
{{- end }}
{{- if .HEALTHCHECK_RETRIES }}
      retries: {{ .HEALTHCHECK_RETRIES }}
{{- end }}
{{- if .HEALTHCHECK_START_PERIOD }}
      start_period: {{ .HEALTHCHECK_START_PERIOD }}
{{- end }}
{{- end }}
{{- if .LABELS }}
    labels:
{{- range $key, $value := .LABELS }}
      {{ $key }}: "{{ $value }}"
{{- end }}
{{- end }}
    restart: unless-stopped
