#!/bin/bash
# deps_install.sh - Dependency installation script
# This script is used to install build-time dependencies in a separate Docker layer
# to leverage Docker's layer caching mechanism for faster builds.
#
# IMPORTANT: This script is executed BEFORE build.sh in the Dockerfile
#
# Environment Variables (automatically set by Dockerfile):
#   - BUILD_OUTPUT_DIR: Absolute path to build output directory (e.g., /opt/dist)
#   - PROJECT_ROOT: Absolute path to project root (e.g., /opt)
#
# Usage Scenarios:
#   1. Install language-specific dependencies (npm install, pip install, go mod download, etc.)
#   2. Download external tools or binaries
#   3. Set up build environment
#
# DO NOT:
#   - Perform actual compilation/build (that's build.sh's job)
#   - Copy/move source files (Dockerfile handles this)
#
# ============================================
# Script Setup
# ============================================

set -e # Exit on error

cd "${PROJECT_ROOT}"

echo "========================================="
echo "TCS Dependency Installation"
echo "Project root: ${PROJECT_ROOT}"
echo "Build output: ${BUILD_OUTPUT_DIR}"
echo "========================================="

# ============================================
# Install Build Dependencies
# ============================================
# Build dependencies are typically executable tools needed for compilation
# Examples: git, make, gcc, etc.
{{- if .BUILD_DEPS_PACKAGES }}
BUILD_PACKAGES="{{ join " " .BUILD_DEPS_PACKAGES }}"
{{- else }}
BUILD_PACKAGES=""
{{- end }}

if [ -n "$BUILD_PACKAGES" ]; then
	echo "Installing build dependencies: $BUILD_PACKAGES"
	echo ""

	# Detect package manager and install all packages at once
	if command -v apk >/dev/null 2>&1; then
		echo "Using apk package manager..."
		apk add --no-cache $BUILD_PACKAGES || {
			echo "ERROR: Failed to install packages with apk"
			exit 1
		}
	elif command -v apt-get >/dev/null 2>&1; then
		echo "Using apt-get package manager..."
		apt-get update -qq && apt-get install -y $BUILD_PACKAGES || {
			echo "ERROR: Failed to install packages with apt-get"
			exit 1
		}
	elif command -v yum >/dev/null 2>&1; then
		echo "Using yum package manager..."
		yum install -y $BUILD_PACKAGES || {
			echo "ERROR: Failed to install packages with yum"
			exit 1
		}
	elif command -v dnf >/dev/null 2>&1; then
		echo "Using dnf package manager..."
		dnf install -y $BUILD_PACKAGES || {
			echo "ERROR: Failed to install packages with dnf"
			exit 1
		}
	elif command -v zypper >/dev/null 2>&1; then
		echo "Using zypper package manager..."
		zypper install -y $BUILD_PACKAGES || {
			echo "ERROR: Failed to install packages with zypper"
			exit 1
		}
	else
		echo "ERROR: No supported package manager found"
		echo "Supported package managers: apk, apt-get, yum, dnf, zypper"
		exit 1
	fi

	echo "✓ All build dependencies installed successfully"
	echo ""
else
	echo "No build dependencies specified, skipping installation"
	echo ""
fi

# ============================================
# Ensure Build Output Directory Exists
# ============================================
echo "Ensuring build output directory exists..."
mkdir -p "${BUILD_OUTPUT_DIR}"
echo "✓ Build output directory ready: ${BUILD_OUTPUT_DIR}"
echo ""

# ============================================
# Detect Project Type and Install Dependencies
# ============================================

# Example 1: Go Project
{{- if eq .LANGUAGE "go" }}
if [ -f "go.mod" ]; then
{{- if .GO_PROXY }}
	go env -w GOPROXY="{{ .GO_PROXY }}"
{{- end }}
{{- if .GO_SUMDB }}
	#Set Go checksum database
	go env -w GOSUMDB="{{ .GO_SUMDB }}"
{{- end }}
	echo "Detected Go project, downloading dependencies..."
	go mod download
fi
{{- end }}

# Example 2: Node.js Project
{{- if eq .LANGUAGE "nodejs" }}
# if [ -f "package.json" ]; then
#     echo "Detected Node.js project, installing dependencies..."
#     npm install --production
#     # Or use yarn
#     # yarn install --production
# fi
{{- end }}

# Example 3: Python Project
{{- if eq .LANGUAGE "python" }}
# if [ -f "requirements.txt" ]; then
#     echo "Detected Python project, installing dependencies..."
#     # Install to system site-packages
#     pip install -r requirements.txt
#
#     # Or install to custom directory (useful for packaging)
#     # mkdir -p "${BUILD_OUTPUT_DIR}/bin"
#     # pip install -r requirements.txt -t "${BUILD_OUTPUT_DIR}/bin/"
# fi
{{- end }}

# Example 4: Java Maven Project
{{- if eq .LANGUAGE "java" }}
# if [ -f "pom.xml" ]; then
#     echo "Detected Maven project, downloading dependencies..."
#     mvn dependency:go-offline
# fi
{{- end }}


# ============================================
# Custom Dependency Installation
# ============================================
# Add your custom dependency installation logic here
# Examples:
#   - Download external binaries
#   - Install system packages (if needed in builder image)
#   - Set up build tools

echo "Dependency installation completed successfully"
