#!/bin/bash
# deps_install.sh - Dependency installation script
# This script is used to install build-time dependencies in a separate Docker layer
# to leverage Docker's layer caching mechanism for faster builds.
#
# IMPORTANT: This script is executed BEFORE build.sh in the Dockerfile
#
# Environment Variables (automatically set by Dockerfile):
#   - BUILD_OUTPUT_DIR: Absolute path to build output directory (e.g., /opt/dist)
#   - PROJECT_ROOT: Absolute path to project root (e.g., /opt)
#
# Usage Scenarios:
#   1. Install language-specific dependencies (npm install, pip install, go mod download, etc.)
#   2. Download external tools or binaries
#   3. Set up build environment
#
# DO NOT:
#   - Perform actual compilation/build (that's build.sh's job)
#   - Copy/move source files (Dockerfile handles this)
#
# ============================================
# Script Setup
# ============================================

set -e # Exit on error

cd "${PROJECT_ROOT}"

echo "========================================="
echo "TCS Dependency Installation"
echo "Project root: ${PROJECT_ROOT}"
echo "Build output: ${BUILD_OUTPUT_DIR}"
echo "========================================="

# ============================================
# 1. Install System Packages
# ============================================
{{- if .HasSystemPackages }}
echo "Installing system packages..."
SYSTEM_PACKAGES="{{ join " " .SystemPackages }}"

# Auto-detect package manager and install
if command -v apk >/dev/null 2>&1; then
	echo "Using apk package manager..."
	apk add --no-cache $SYSTEM_PACKAGES || {
		echo "ERROR: Failed to install packages with apk"
		exit 1
	}
elif command -v apt-get >/dev/null 2>&1; then
	echo "Using apt-get package manager..."
	apt-get update -qq && apt-get install -y $SYSTEM_PACKAGES || {
		echo "ERROR: Failed to install packages with apt-get"
		exit 1
	}
elif command -v yum >/dev/null 2>&1; then
	echo "Using yum package manager..."
	yum install -y $SYSTEM_PACKAGES || {
		echo "ERROR: Failed to install packages with yum"
		exit 1
	}
elif command -v dnf >/dev/null 2>&1; then
	echo "Using dnf package manager..."
	dnf install -y $SYSTEM_PACKAGES || {
		echo "ERROR: Failed to install packages with dnf"
		exit 1
	}
elif command -v zypper >/dev/null 2>&1; then
	echo "Using zypper package manager..."
	zypper install -y $SYSTEM_PACKAGES || {
		echo "ERROR: Failed to install packages with zypper"
		exit 1
	}
else
	echo "ERROR: No supported package manager found"
	echo "Supported: apk, apt-get, yum, dnf, zypper"
	exit 1
fi

echo "✓ System packages installed successfully"
echo ""
{{- else }}
echo "No system packages to install"
echo ""
{{- end }}

# ============================================
# 2. Ensure Build Output Directory Exists
# ============================================
echo "Ensuring build output directory exists..."
mkdir -p "${BUILD_OUTPUT_DIR}"
echo "✓ Build output directory ready: ${BUILD_OUTPUT_DIR}"
echo ""

# ============================================
# 3. Install Custom Packages
# ============================================
{{- if .HasCustomPackages }}
echo "Installing custom packages..."

{{- range .CustomPackages }}
echo "----------------------------------------"
echo "Installing {{ .Name }}..."
{{- if .Description }}
echo "Description: {{ .Description }}"
{{- end }}

# Execute install command
{{- if .Required }}
# Required package - fail on error
set -e
{{ .InstallCommand }}
echo "✓ {{ .Name }} installed successfully"
{{- else }}
# Optional package - continue on error
set +e
{{ .InstallCommand }}
INSTALL_RESULT=$?
set -e
if [ $INSTALL_RESULT -ne 0 ]; then
	echo "⚠ Warning: Failed to install {{ .Name }} (optional)"
else
	echo "✓ {{ .Name }} installed successfully"
fi
{{- end }}
echo ""
{{- end }}

echo "All custom packages processed"
echo ""
{{- else }}
echo "No custom packages to install"
echo ""
{{- end }}


# ============================================
# 4. Install Language Dependencies
# ============================================

# Example 1: Go Project
{{- if eq .Language "go" }}
if [ -f "go.mod" ]; then
{{- if .GoProxy }}
	go env -w GOPROXY="{{ .GoProxy }}"
{{- end }}
{{- if .GoSumDB }}
	go env -w GOSUMDB="{{ .GoSumDB }}"
{{- end }}
	echo "Downloading Go dependencies..."
	go mod download
	echo "✓ Go dependencies downloaded"
fi
{{- end }}

# Example 2: Node.js Project
{{- if eq .Language "nodejs" }}
if [ -f "package.json" ]; then
	echo "Installing Node.js dependencies..."
	npm install --production
	echo "✓ Node.js dependencies installed"
fi
{{- end }}

# Example 3: Python Project
{{- if eq .Language "python" }}
if [ -f "requirements.txt" ]; then
	echo "Installing Python dependencies..."
	pip install -r requirements.txt
	echo "✓ Python dependencies installed"
fi
{{- end }}

# Example 4: Java Maven Project
{{- if eq .Language "java" }}
if [ -f "pom.xml" ]; then
	echo "Downloading Maven dependencies..."
	mvn dependency:go-offline
	echo "✓ Maven dependencies downloaded"
fi
{{- end }}

echo "=========================================="
echo "Build Dependencies Installation Completed"
echo "=========================================="
